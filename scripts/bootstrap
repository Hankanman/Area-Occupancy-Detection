#!/bin/sh

# script/bootstrap: Install/update all dependencies required to run the project

set -e

cd "$(dirname "$0")/.."

echo "==> Checking for uv..."
if ! command -v uv >/dev/null 2>&1; then
  echo "UV not found, installing..."
  if ! curl -LsSf https://astral.sh/uv/install.sh | sh; then
    echo "ERROR: uv installer failed" >&2
    exit 1
  fi

  # Verify uv is now available on PATH
  if ! command -v uv >/dev/null 2>&1; then
    # Try adding common install locations to PATH
    export PATH="$HOME/.local/bin:$PATH"
    export PATH="/usr/local/bin:$PATH"

    # Re-check after adding common paths
    if ! command -v uv >/dev/null 2>&1; then
      echo "ERROR: uv installer completed but uv is not found on PATH" >&2
      echo "Please run: source ~/.bashrc  (or ~/.zshrc, ~/.profile, etc.)" >&2
      echo "Or manually add uv to your PATH and re-run this script" >&2
      exit 1
    fi
  fi
fi

echo "==> Checking for system dependencies..."
# libturbojpeg is needed by HA's camera component (PyTurboJPEG)
if ldconfig -p 2>/dev/null | grep -q libturbojpeg; then
  echo "    libturbojpeg found"
elif [ -f /etc/debian_version ]; then
  echo "    Installing libturbojpeg (Debian/Ubuntu)..."
  sudo apt-get install -y libturbojpeg0
elif [ -f /etc/fedora-release ] || [ -f /etc/redhat-release ]; then
  echo "    Installing libturbojpeg (Fedora/RHEL)..."
  sudo dnf install -y turbojpeg
else
  echo "    WARNING: libturbojpeg not found. Install it manually for camera snapshot support."
fi

echo "==> Creating virtual environment if needed..."
if [ ! -d ".venv" ]; then
    uv venv --python 3.13
fi

echo "==> Installing root project dependencies..."
uv sync --extra dev --extra test --extra viz

echo "==> Installing simulator dependencies..."
(cd simulator && unset VIRTUAL_ENV && uv sync --python ../.venv/bin/python)

echo "==> Installing docs dependencies..."
(cd docs && unset VIRTUAL_ENV && uv sync --python ../.venv/bin/python)

echo "==> Installing pre-commit hooks..."
uv run pre-commit install

echo "==> Bootstrap completed!"