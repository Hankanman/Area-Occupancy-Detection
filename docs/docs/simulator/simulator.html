<link rel="stylesheet" href="../assets/simulator/style.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css"
  id="shoelace-theme-light" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/dark.css"
  id="shoelace-theme-dark" disabled />
<div class="aod-simulator sim-stack md-typeset">
  <div id="simulation-display" class="sim-stack">
    <div class="sim-layout">
      <div class="sim-header sim-sticky">
        <div class="sim-header-content">
          <div class="sim-prob-chart">
            <canvas id="probability-chart"></canvas>
            <div class="sim-prob-overlay">
              <div id="probability-value">0.00%</div>
            </div>
          </div>
          <div class="sim-header-actions">
            <sl-select id="area-selector" placeholder="Select area..." disabled style="min-width: 200px">
              <sl-option value="">No areas loaded</sl-option>
            </sl-select>
            <sl-button id="help-dialog-btn" variant="default">
              <sl-icon slot="prefix" name="question-circle"></sl-icon>
              Help
            </sl-button>
            <sl-dialog label="How to Use the Simulator" id="help-dialog" class="help-dialog">
              <h1>Area Occupancy Detection Simulator</h1>

              <p>
                This simulator lets you interactively explore how sensor states,
                weights, and prior probabilities affect occupancy calculations.
                It uses the <strong>exact same Python code</strong> that runs in
                your Home Assistant integration, ensuring calculations match
                exactly what happens in your actual setup.
              </p>

              <h2>Getting Started</h2>

              <p>
                <strong>Step 1:</strong> In Home Assistant, run the
                <a href="../features/services/#area_occupancyrun_analysis">"Run Analysis" service</a>
                for your area(s). This generates YAML output with all your
                sensors, their states, likelihoods, and current probability
                calculations.
              </p>

              <p>
                <strong>Step 2:</strong> Copy the entire YAML output from the
                service call and paste it into the
                <strong>"Service YAML Input"</strong>
                text area below.
              </p>

              <p>
                <strong>Step 3:</strong> Click
                <strong>"Load Simulation"</strong> to send the data to the
                simulator server. The simulator will populate with your sensors,
                current states, and all configuration values.
              </p>

              <p>
                <strong>Step 4:</strong> If your analysis output contains
                multiple areas, use the <strong>Area</strong> dropdown to switch
                between them.
              </p>

              <h2>Understanding the Interface</h2>

              <h3>Header Section</h3>
              <ul>
                <li>
                  <strong>Area Name:</strong> The name of the currently selected
                  area
                </li>
                <li>
                  <strong>Probability Value:</strong> The calculated occupancy
                  probability (0-100%)
                </li>
                <li>
                  <strong>Probability Bar:</strong> Visual representation of the
                  current probability
                </li>
                <li>
                  <strong>Probability Chart:</strong> Time-series graph showing
                  how probability changes over time as you interact with sensors
                </li>
              </ul>

              <h3>Sensors Section</h3>
              <p>Each sensor card displays:</p>
              <ul>
                <li>
                  <strong>Sensor Name:</strong> Friendly name or entity ID
                </li>
                <li>
                  <strong>Current State:</strong> The sensor's current value or
                  state
                </li>
                <li>
                  <strong>Type & Weight:</strong> Sensor type (motion, media,
                  door, etc.) and its weight in calculations
                </li>
                <li>
                  <strong>Likelihood Values:</strong> P(active|occupied) and
                  P(active|vacant) probabilities
                </li>
                <li>
                  <strong>Controls:</strong>
                  <ul>
                    <li>
                      <strong>Binary Sensors:</strong> Toggle switch or buttons
                      to set active/inactive states
                    </li>
                    <li>
                      <strong>Numeric Sensors:</strong> Input field to enter
                      temperature, humidity, illuminance, or other numeric
                      values
                    </li>
                  </ul>
                </li>
                <li>
                  <strong>Metrics:</strong> Contribution (how much this sensor
                  affects probability), Likelihood, and Decay Factor (if sensor
                  is decaying)
                </li>
              </ul>

              <h3>Prior Probabilities Section</h3>
              <ul>
                <li>
                  <strong>Global Prior:</strong> Base probability that the area
                  is occupied, independent of time or sensor evidence
                </li>
                <li>
                  <strong>Time Prior:</strong> Learned probability based on
                  schedules or historical activity patterns
                </li>
                <li>
                  <strong>Combined Prior:</strong> Weighted combination of
                  global and time priors
                </li>
                <li>
                  <strong>Final Prior:</strong> Effective prior after Bayesian
                  factor and clamping are applied
                </li>
                <li>
                  <strong>Area Purpose:</strong> Select a purpose (Social, Work,
                  Rest, etc.) to auto-populate decay settings
                </li>
                <li>
                  <strong>Half-life:</strong> Time in seconds for sensor
                  evidence to decay by 50% when inactive
                </li>
              </ul>

              <h3>Entity Type Weights Section</h3>
              <p>
                Adjust the weight (influence) of each sensor type on the overall
                probability calculation:
              </p>
              <ul>
                <li><strong>Motion:</strong> Motion sensors (default: 1.0)</li>
                <li><strong>Media:</strong> Media players (default: 0.85)</li>
                <li><strong>Appliance:</strong> Appliances (default: 0.4)</li>
                <li><strong>Door:</strong> Door sensors (default: 0.3)</li>
                <li><strong>Window:</strong> Window sensors (default: 0.2)</li>
                <li>
                  <strong>Illuminance:</strong> Light level sensors (default:
                  0.1)
                </li>
                <li>
                  <strong>Humidity:</strong> Humidity sensors (default: 0.1)
                </li>
                <li>
                  <strong>Temperature:</strong> Temperature sensors (default:
                  0.1)
                </li>
              </ul>
              <p>
                Higher weights mean that sensor type has more influence on the
                final probability. Weights apply to all sensors of that type.
              </p>

              <h2>What You Can Do</h2>

              <ul>
                <li>
                  <strong>Toggle Binary Sensors:</strong> Use switches or
                  buttons to change motion, door, window, and appliance states.
                  See immediate probability updates.
                </li>
                <li>
                  <strong>Adjust Numeric Sensors:</strong> Enter new values for
                  temperature, humidity, or illuminance sensors to see how they
                  affect probability.
                </li>
                <li>
                  <strong>Modify Entity Type Weights:</strong> Use sliders to
                  change how much each sensor type contributes. Changes apply to
                  all sensors of that type.
                </li>
                <li>
                  <strong>Experiment with Priors:</strong> Adjust global and
                  time priors to see how base probabilities affect calculations.
                </li>
                <li>
                  <strong>Change Area Purpose:</strong> Select different
                  purposes to see how decay settings change based on area type.
                </li>
                <li>
                  <strong>Observe Decay:</strong> When sensors become inactive,
                  watch how their evidence decays over time based on the
                  half-life setting.
                </li>
                <li>
                  <strong>View Detailed Metrics:</strong> See likelihood,
                  contribution, and decay factors for each sensor to understand
                  its impact.
                </li>
                <li>
                  <strong>Track Changes:</strong> The probability chart shows
                  the last 30 updates, helping you visualize how probability
                  evolves.
                </li>
                <li>
                  <strong>Switch Between Areas:</strong> If your analysis
                  contains multiple areas, use the Area dropdown to simulate
                  different areas.
                </li>
              </ul>

              <h2>How It Works</h2>

              <p>
                The simulator uses a stateless architecture where each
                interaction sends the current configuration to a server running
                the
                <strong>actual Python code</strong> from the Area Occupancy
                Detection integration. This ensures:
              </p>

              <ul>
                <li>
                  Calculations match exactly what happens in Home Assistant
                </li>
                <li>
                  You can test different scenarios and configurations before
                  implementing them
                </li>
                <li>
                  You can understand how each sensor, weight, and prior affects
                  the final probability
                </li>
                <li>
                  The probability chart provides a visual history of changes
                </li>
                <li>
                  Real-time updates occur automatically every second, or
                  immediately when you change a control
                </li>
              </ul>

              <h2>Tips</h2>

              <ul>
                <li>
                  The <strong>API Status</strong> badge shows whether the
                  simulator server is online and responding.
                </li>
                <li>
                  Sensor contributions show positive values when the sensor
                  increases probability and negative values when it decreases
                  probability.
                </li>
                <li>
                  Decay factors apply when sensors transition from active to
                  inactive, gradually reducing their influence over time.
                </li>
                <li>
                  All changes are calculated in real-time, so you get immediate
                  feedback on how your configuration behaves.
                </li>
                <li>
                  The simulator preserves your YAML data when switching between
                  areas, so you can easily compare different areas from the same
                  analysis.
                </li>
              </ul>

              <sl-button slot="footer" variant="primary" onclick="document.getElementById('help-dialog').hide()">
                Close
              </sl-button>
            </sl-dialog>
            <sl-button id="load-btn" variant="primary">Load Simulation</sl-button>
          </div>
        </div>
      </div>
      <main class="sim-stack">
        <sl-details class="md-card sim-section" summary="Sensors">
          <div id="sensors-container" class="sim-card-grid"></div>
        </sl-details>
        <sl-details class="md-card sim-section" summary="Prior Probabilities">
          <div class="sim-controls">
            <sl-range label="Global Prior" data-label="Global Prior" min="0" max="1" step="0.01" value="0.5"
              id="global-prior-slider" help-text="Base probability before accounting for sensor evidence."></sl-range>
            <sl-range label="Time Prior" data-label="Time Prior" min="0" max="1" step="0.01" value="0.5"
              id="time-prior-slider"
              help-text="Learned probability based on schedules or historical activity."></sl-range>
            <sl-input label="Combined Prior" value="50.00%" disabled id="combined-prior-input"
              help-text="Weighted result of global and time priors."></sl-input>
            <sl-input label="Final Prior (after factor &amp; clamp)" value="50.00%" disabled id="final-prior-input"
              help-text="Effective prior after Bayesian factor and clamping are applied."></sl-input>
            <sl-select id="purpose-select" label="Area Purpose" clearable
              help-text="Choose a purpose to auto-populate decay settings.">
              <sl-option value="">Loading...</sl-option>
            </sl-select>
            <sl-input id="half-life-display" label="Half-life" value="--" disabled
              help-text="Half-life returned from analysis."></sl-input>
          </div>
        </sl-details>
        <sl-details class="md-card sim-section" summary="Entity Type Weights">
          <div class="sim-controls sim-controls--autofit">
            <sl-range label="Motion" data-label="Motion" min="0.01" max="1.0" step="0.01" value="1.0"
              id="weight-motion-slider"></sl-range>
            <sl-range label="Media" data-label="Media" min="0.01" max="1" step="0.01" value="0.85"
              id="weight-media-slider"></sl-range>
            <sl-range label="Appliance" data-label="Appliance" min="0.01" max="1" step="0.01" value="0.4"
              id="weight-appliance-slider"></sl-range>
            <sl-range label="Door" data-label="Door" min="0.01" max="1" step="0.01" value="0.3"
              id="weight-door-slider"></sl-range>
            <sl-range label="Window" data-label="Window" min="0.01" max="1" step="0.01" value="0.2"
              id="weight-window-slider"></sl-range>
            <sl-range label="Illuminance" data-label="Illuminance" min="0.01" max="1" step="0.01" value="0.1"
              id="weight-illuminance-slider"></sl-range>
            <sl-range label="Humidity" data-label="Humidity" min="0.01" max="1" step="0.01" value="0.1"
              id="weight-humidity-slider"></sl-range>
            <sl-range label="Temperature" data-label="Temperature" min="0.01" max="1" step="0.01" value="0.1"
              id="weight-temperature-slider"></sl-range>
          </div>
        </sl-details>
        <sl-details class="md-card sim-section" summary="Service YAML Input" open>
          <div class="sim-controls">
            <span id="api-status-badge" role="status" aria-live="polite">Checking</span>
            <sl-textarea id="yaml-input" placeholder="Paste your YAML analysis output here..."
              help-text="Paste the YAML returned from the run_analysis service."></sl-textarea>
            <sl-alert id="error-alert" variant="danger" closable duration="0" hidden>
              <sl-icon slot="icon" name="exclamation-octagon"></sl-icon>
              <strong>Something went wrong</strong>
              <div id="error-message" aria-live="assertive"></div>
              <sl-button slot="actions" variant="default" id="error-retry" hidden>
                Retry
              </sl-button>
            </sl-alert>
          </div>
        </sl-details>
      </main>
    </div>
  </div>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script defer src="../assets/simulator/themeDetector.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace.js"></script>
<script defer src="../assets/simulator/app.js"></script>